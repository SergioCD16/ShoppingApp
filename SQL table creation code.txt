USE ShoppingApp;

-- Tabla de usuarios
CREATE TABLE User (
    UserID INT AUTO_INCREMENT PRIMARY KEY,
    Name VARCHAR(100) NOT NULL,
    Email VARCHAR(100) UNIQUE NOT NULL,
    Password VARCHAR(100) NOT NULL,
    PhoneNumber VARCHAR(20),
    Type ENUM('INDIVIDUAL', 'BUSINESS') NOT NULL
);

-- Subtipos
CREATE TABLE IndividualUser (
    UserID INT PRIMARY KEY,
    DNI VARCHAR(20) UNIQUE NOT NULL,
    FOREIGN KEY (UserID) REFERENCES User(UserID)
);

CREATE TABLE BusinessUser (
    UserID INT PRIMARY KEY,
    CIF VARCHAR(20) UNIQUE NOT NULL,
    FOREIGN KEY (UserID) REFERENCES User(UserID)
);

-- Direcciones
CREATE TABLE Address (
    AddressID INT AUTO_INCREMENT PRIMARY KEY,
    StreetName VARCHAR(100),
    Number VARCHAR(10),
    ZipCode VARCHAR(10),
    City VARCHAR(50),
    UserID INT UNIQUE,
    FOREIGN KEY (UserID) REFERENCES User(UserID)
);

-- Tarjetas de crédito
CREATE TABLE CreditCard (
    CardID INT AUTO_INCREMENT PRIMARY KEY,
    Name VARCHAR(100),
    Number VARCHAR(20),
    CVV VARCHAR(5),
    ExpDate DATE,
    UserID INT UNIQUE,
    FOREIGN KEY (UserID) REFERENCES User(UserID)
);

-- Productos
CREATE TABLE Product (
    ProductID INT AUTO_INCREMENT PRIMARY KEY,
    Title VARCHAR(100) NOT NULL,
    Category VARCHAR(50),
    Description TEXT,
    Picture BLOB,
    Price DECIMAL(10,2),
    Stock INT,
    EntryDate DATETIME DEFAULT NOW()
);

-- Reseñas
CREATE TABLE Review (
    ReviewID INT AUTO_INCREMENT PRIMARY KEY,
    Mark INT CHECK (Mark BETWEEN 1 AND 5),
    Message TEXT,
    Date DATETIME DEFAULT NOW(),
    ProductID INT,
    FOREIGN KEY (ProductID) REFERENCES Product(ProductID)
);

-- Órdenes de compra
CREATE TABLE PurchaseOrder (
    OrderID INT AUTO_INCREMENT PRIMARY KEY,
    UserID INT,
    PurchaseDone BOOLEAN DEFAULT FALSE,
    PurchaseDate DATETIME,
    FOREIGN KEY (UserID) REFERENCES User(UserID)
);

-- Items de la orden (relación N:M entre órdenes y productos)
CREATE TABLE ItemOrder (
    ItemID INT AUTO_INCREMENT PRIMARY KEY,
    OrderID INT,
    ProductID INT,
    Quantity INT,
    FOREIGN KEY (OrderID) REFERENCES PurchaseOrder(OrderID),
    FOREIGN KEY (ProductID) REFERENCES Product(ProductID)
);

CREATE USER 'shopping_user'@'localhost' IDENTIFIED BY 'g76pL/~|oHAO0Z=';
GRANT SELECT, INSERT, UPDATE, DELETE ON shoppingapp.* TO 'shopping_user'@'localhost';
FLUSH PRIVILEGES;